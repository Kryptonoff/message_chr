<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ß–∞—Ç - –ö–æ–º–Ω–∞—Ç–∞ —á–∞—Ç–∞</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css"></link>
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://cdn.socket.io/4.0.0/socket.io.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/emoji-js/3.6.0/emoji.min.js"></script>
    <style>
        .emoji-picker {
            display: none; /* –°–∫—Ä—ã–≤–∞–µ–º –ø–∞–Ω–µ–ª—å —Å–º–∞–π–ª–æ–≤ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é */
            flex-wrap: wrap;
            max-width: 300px;
            margin-bottom: 10px;
            border: 1px solid #ccc;
            padding: 10px;
            background-color: #fff;
            position: absolute; /* –ü–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä—É–µ–º –ø–∞–Ω–µ–ª—å */
            z-index: 1000; /* –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —É—Ä–æ–≤–µ–Ω—å –Ω–∞–¥ –¥—Ä—É–≥–∏–º–∏ —ç–ª–µ–º–µ–Ω—Ç–∞–º–∏ */
        }
        .emoji {
            cursor: pointer;
            font-size: 24px;
            margin: 5px;
        }
    </style>
</head>
<body class="bg-gray-100">
    <div class="container mx-auto p-4">
        <div class="flex justify-between items-center mb-4">
            <h1 class="text-3xl font-bold">–ß–∞—Ç</h1>
            <a href="{{ url_for('logout') }}" class="btn btn-danger bg-red-500 text-white px-4 py-2 rounded">–í—ã–π—Ç–∏</a>
        </div>
        <div id="messages" class="mb-3 h-80 overflow-y-scroll border border-gray-300 p-4 bg-white rounded shadow break-words"></div>
        
        <form id="messageForm" class="flex items-center relative">
            <input id="messageInput" class="form-control flex-grow border border-gray-300 p-2 rounded mr-2" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ" required>
            <button id="emojiButton" type="button" class="btn btn-secondary bg-gray-300 text-gray-700 px-4 py-2 rounded mr-2">üòä</button>
            <button class="btn btn-primary bg-blue-500 text-white px-4 py-2 rounded">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>

            <div class="emoji-picker absolute bottom-12 left-0" id="emojiPicker">
                <span class="emoji" data-emoji=":smile:">üòÄ</span>
                <span class="emoji" data-emoji=":heart:">‚ù§Ô∏è</span>
                <span class="emoji" data-emoji=":thumbsup:">üëç</span>
                <span class="emoji" data-emoji=":laughing:">üòÜ</span>
                <span class="emoji" data-emoji=":cry:">üò¢</span>
                <span class="emoji" data-emoji=":angry:">üò†</span>
                <span class="emoji" data-emoji=":sunglasses:">üòé</span>
                <span class="emoji" data-emoji=":wink:">üòâ</span>
            </div>
        </form>
    </div>

    <script>
        const socket = io();
        const emoji = new EmojiConvertor();
        emoji.replace_mode = 'unified';
        emoji.allow_native = true;

        socket.emit('get_messages');

        $('#messageForm').submit(function(e) {
            e.preventDefault();
            const message = $('#messageInput').val();
            socket.emit('send_message', { nickname: '{{ username }}', message: message });
            $('#messageInput').val('');
        });

        $('.emoji').click(function() {
            const emojiCode = $(this).data('emoji');
            $('#messageInput').val($('#messageInput').val() + emojiCode);
            $('#messageInput').focus();
            $('#emojiPicker').hide();
        });

        $('#emojiButton').click(function() {
            $('#emojiPicker').toggle();
        });

        $(document).click(function(event) {
            if (!$(event.target).closest('#emojiButton').length && !$(event.target).closest('#emojiPicker').length) {
                $('#emojiPicker').hide();
            }
        });

        socket.on('receive_message', function(data) {
            const messageWithEmojis = emoji.replace_colons(data.message);
            const isAuthor = data.nickname === '{{ username }}';
            const deleteButton = isAuthor ? `<button class="btn btn-danger btn-sm delete-message bg-red-500 text-white px-2 py-1 rounded" data-id="${data.id}">–£–¥–∞–ª–∏—Ç—å</button>` : '';
    
    const messageElement = `
        <div id="message-${data.id}" class="mb-2 p-2 border-b border-gray-200 break-words">
            <div class="flex justify-between items-center">
                <div>
                    <strong class="font-semibold" style="color: ${data.color};">${data.nickname}</strong>
                    <span class="text-gray-500 text-sm ml-2">${data.timestamp}</span>
                </div>
                ${deleteButton}
            </div>
            <p class="mt-1 font-medium">${messageWithEmojis}</p>
        </div>`;
    $('#messages').append(messageElement);
    $('#messages').scrollTop($('#messages')[0].scrollHeight);
});

socket.on('all_messages', function(messages) {
    $('#messages').empty();
    messages.forEach(function(msg) {
        const messageWithEmojis = emoji.replace_colons(msg.message);
        const isAuthor = msg.nickname === '{{ username }}';
        const deleteButton = isAuthor ? `<button class="btn btn-danger btn-sm delete-message bg-red-500 text-white px-2 py-1 rounded" data-id="${msg.id}">–£–¥–∞–ª–∏—Ç—å</button>` : '';

        const messageElement = `
            <div id="message-${msg.id}" class="mb-2 p-2 border-b border-gray-200 break-words">
                <div class="flex justify-between items-center">
                    <div>
                        <strong class="font-semibold" style="color: ${data.color};">${msg.nickname}</strong>
                        <span class="text-gray-500 text-sm ml-2">${msg.timestamp}</span>
                    </div>
                    ${deleteButton}
                </div>
                <p class="mt-1 font-medium">${messageWithEmojis}</p>
            </div>`;
        $('#messages').append(messageElement);
    });
    $('#messages').scrollTop($('#messages')[0].scrollHeight);
});

$(document).on('click', '.delete-message', function() {
    const messageId = $(this).data('id');
    socket.emit('delete_message', { id: messageId });
});

socket.on('message_deleted', function(data) {
    $(`#message-${data.id}`).remove();
});

socket.on('error', function(data) {
    alert(data.message);
});
</script>
</body>
</html>